#!/usr/bin/env fish

# Check if at least one IP was provided
if test (count $argv) -eq 0
    echo "Usage: ./script <ip1> <ip2> <ip3> ..."
    exit 1
end

# Define the command to run on each host
set command 'nix-shell -p ssh-to-age --run "cat /etc/ssh/ssh_host_ed25519_key.pub | ssh-to-age"'

# Loop through each provided IP, clear known_hosts entry, and run the command
for host in $argv
    # Remove host from known_hosts and suppress output
    ssh-keygen -R $host &>/dev/null

    # Execute the command on the host with StrictHostKeyChecking set to "accept-new"
    set output (ssh -o StrictHostKeyChecking=accept-new root@$host $command 2>/dev/null | tail -n 1)

    # Display the output in "ip: age..." format
    echo "$host: $output"
end
